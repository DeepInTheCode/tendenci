{% extends "memberships/base.html" %}
{% load base_tags %}
{% load base_filters %}
{% load i18n %}

{% block title %}{% trans "Export Memberships - Status" %}{% endblock %}

{% block extra_head %}
{{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/memberships.css">
    <style>
        .display-hide{
            display: none;
        }
    </style>
{% endblock %}

{% block body %}
<div id="membership-export-wrap">
    {% if corp_profile %}
    <h1>{% trans "Roster Export for Corp. Membership: " %}{{ corp_profile.name }} {% trans " - Status" %}</h1>
    {% else %}
    <h1>{% trans "Membership CSV Export - Status" %}</h1>
    {% endif %}
   
    <div id="membership-export">
       
       <div id="display-content"{% if not download_ready %} class="display-hide"{% endif %}>
       <p>The export file is ready, click the link below to download.</p>
       <div>
           <a href="{% url memberships.default_export_download identifier %}{% if corp_profile %}?cp_id={{ corp_profile.id }}{% endif %}">Download Now</a>  
       </div>
       <div>&nbsp;</div>
       {% if corp_profile %}
       <div>
       {% if request.user.profile.is_superuser %}
           <a href="{% url corpmembership.search %}">{% trans "Back to Corp. Memberships" %} &raquo;</a>
       {% else %}
            <a href="{% url corpmembership.mycorps %}">{% trans "Back to Corp. Memberships" %} &raquo;</a>
       {% endif %}
       </div>
        {% endif %}
       </div>
       {% if not download_ready %}
       <div id="display-loading" style="margin: 5em;">
            <img src="{{ STATIC_URL }}images/loadingicon.gif" alt="loading">
            <div style="color: #0D4C83;"><small>Please wait while we're processing...</small></div>
        </div>
       {% endif %}
    </div>
</div>
{% endblock %}


{% block extra_body %}
<script type="text/javascript">
{% if not download_ready  %}

  $(document).ready(function() {
    var value;
    var status_check_intval;
    
    var status_check = function(){
        $.ajax({
           type: "POST",
           url: "{% url memberships.default_export_check_status identifier %}{% if corp_profile %}?cp_id={{ corp_profile.id }}{% endif %}",
           success: function(status_data){
               if (status_data == 'done'){
                   clearInterval(status_check_intval);
                   $('#display-loading').hide();
                   $('#display-content').show();
               }
             },
             error: function(data){
               clearInterval(status_check_intval);
             }
         });
     }
    
    status_check();
    status_check_intval = setInterval(function() {
        status_check();  // check every 60 seconds
    }, 60000);
    
  });
  
{% endif %}
</script>

{% endblock %}

